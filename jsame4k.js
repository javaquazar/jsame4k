function m(t){return{x:t.clientX-V.getBoundingClientRect().left,y:t.clientY-V.getBoundingClientRect().top}}function s(t){for(var n=1;n<arguments.length;n++)t=t.replace(/%s/,arguments[n]);return t}function Q(t){var n=t>>16,r=t>>8&255,o=255&t;return[n,r,o]}function h(t){var n=t[0]<<16|t[1]<<8|t[2];return"#"+function(t){return Array(7-t.length).join("0")+t}(n.toString(16))}function b(t){var n=t[0],r=t[1],o=t[2],e=Math.floor(1/(1-F));return 0==n&&0==r&&0==o?[e,e,e]:(n>0&&e>n&&(n=e),r>0&&e>r&&(r=e),o>0&&e>o&&(o=e),[Math.min(Math.floor(n/F),255),Math.min(Math.floor(r/F),255),Math.min(Math.floor(o/F),255)])}function d(t){return[Math.max(Math.floor(t[0]*F,0)),Math.max(Math.floor(t[1]*F,0)),Math.max(Math.floor(t[2]*F,0))]}function u(){l=Array(2*C.length-1);for(var t=0;t<C.length;t++)l[t]=q(Q(C[t]),!0),l[2*C.length-2-t]=q(Q(C[t]),!1)}function q(t,n){var r=document.createElement("canvas");r.width=T,r.height=T;var o=r.getContext("2d"),e=n?b(t):t,f=b(e),l=d(e);o.fillStyle=h(l),o.fillRect(0,0,T,T),o.fillStyle=h(e),o.fillRect(0,0,T-1,T-1),o.fillStyle=h(f),o.fillRect(1,1,T-3,T-3);var a=o.createLinearGradient(2,2,T-4,T-4);return a.addColorStop(0,h(e)),a.addColorStop(1,h(f)),o.fillStyle=a,o.fillRect(2,2,T-4,T-4),n&&(o.fillStyle=h(l),o.fillRect(8,8,T-16,T-16)),r}function p(){X.fillStyle="#262c4b",X.fillRect(0,0,W*T+2*B,H*T+2*B),X.fillStyle="#484d50",X.fillRect(0,H*T+2*B,W*T+2*B,S),X.font="bold 12px sans-serif",z[1]=M>1?s("Marked: %s (%s points)",M,P(M)):E?"":"Game Over!",z[2]=s("Score: %s",R);for(var n=0;n<z.length;n++)X.fillStyle="#62696a",X.fillRect(Math.floor((W*T+2*B)/3)*n+1,H*T+2*B+1,Math.floor((W*T+2*B)/3)-2,S-2),X.fillStyle="#ffffff",X.fillText(z[n],Math.floor((W*T+2*B)/6)*(2*n+1)-Math.floor(X.measureText(z[n]).width/2),H*T+2*B+Math.floor(S/2)+4);for(var r=0;W>r;r++)for(var o=0;H>o;o++)X.drawImage(l[t[W*o+r]+N],r*T+B,o*T+B)}function Z(){M=0,R=0,A=!1,E=!0;for(var n=0;n<t.length;n++)t[n]=Math.floor(Math.random()*N+1)}function L(n,r){return 0>n||0>r||n>W-1||r>H-1?0:t[W*r+n]}function I(t,n){return L(t,n)<0}function G(t,n){return 0==L(t,n)}function Y(t,n){return L(t,n)<0?-1*L(t,n):L(t,n)}function P(t){return t*t-4*t+4}function J(t,n){return O(t,n,Y(t,n))}function O(n,r,o){if(I(n,r)||o!=Y(n,r)||G(n,r))return 0;var e=1;return t[W*r+n]=-1*Y(n,r),e+=O(n-1,r,Y(n,r)),e+=O(n,r-1,Y(n,r)),e+=O(n+1,r,Y(n,r)),e+=O(n,r+1,Y(n,r))}function K(){for(var n=0;n<t.length;n++)t[n]=t[n]<0?-1*t[n]:t[n]}function w(n,r,o,e){var f=W*r+n,l=W*e+o,a=t[f];t[f]=t[l],t[l]=a}function D(t,n){var r=m(t),o=r.x<B?-1:Math.floor((r.x-B)/T),e=r.y<B?-1:Math.floor((r.y-B)/T);if((v.x!=o||v.y!=e)&&!I(o,e)||n){if(G(o,e)&&G(v.x,v.y))return v.x=o,void(v.y=e);K(),M=J(o,e),p(),v.x=o,v.y=e}}function U(t,n){var r=m(t),o=r.x<B?-1:Math.floor((r.x-B)/T),e=r.y<B?-1:Math.floor((r.y-B)/T);(v.x!=o||v.y!=e||n)&&(K(),M=0,p(),v.x=o,v.y=e)}function init(){V=document.getElementById("jsame4k"),null!=V&&V.getContext&&(X=V.getContext("2d"),u(),t=Array(W*H),v={x:-1,y:-1},z=["New Game","",""],Z(),p(),V.addEventListener("mousedown",function(n){var r,o,e,f,l=m(n);l.x>0&&l.x<Math.floor((W*T+2*B)/3)-1&&l.y>H*T+2*B&&l.y<H*T+2*B+S-1&&(Z(),E=!0,M=0,p());var a=l.x<B?-1:Math.floor((l.x-B)/T),i=l.y<B?-1:Math.floor((l.y-B)/T);for(o=0,e=0;e<t.length;e++)t[e]<0&&o++;if(o>=2){for(e=0;e<t.length;e++)t[e]<0&&(t[e]=0);for(f=0;W>f;f++)for(r=!0;r;)for(r=!1,l=1;H>l;l++)G(f,l)&&!G(f,l-1)&&(w(f,l,f,l-1),r=!0);for(r=!0;r;)for(r=!1,f=1;W>f;f++)if(G(f-1,H-1)&&!G(f,H-1)){for(l=0;H>l;l++)w(f,l,f-1,l);r=!0}for(R+=P(o),r=!0,o=0,e=0;W>e;e++)for(f=0;H>f;f++)if(!G(e,f)&&(o++,l=Y(e,f),Y(e-1,f)==l||Y(e,f-1)==l||Y(e+1,f)==l||Y(e,f+1)==l)){r=!1;break}0!=o||A||(A=!0,R+=1e3),M=0,r||(M=J(a,i)),r&&E&&(E=!1,M=0),p()}},!1),V.addEventListener("mouseup",function(t){D(t,!0)},!1),V.addEventListener("mousemove",function(t){D(t,!1)},!1),V.addEventListener("mouseover",function(t){D(t,!1)},!1),V.addEventListener("mouseout",function(t){U(t,!0)},!1))}var W=20,H=15,T=26,S=20,B=4,C=[9522747,8094582,4022919,11503186,2501707],F=.7,N=C.length-1,l,t,z,V,X,E,v,R,M,A;init();
